<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Dashboard - Crypto Deposit Platform</title>

<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
    background:#f5f5f5;
    min-height:100vh;
}
.navbar {
    background: linear-gradient(135deg,#1e3c72,#2a5298);
    color:white;
    padding:20px 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.nav-content {
    max-width:1400px;
    margin:auto;
    padding:0 20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.nav-content h2 { font-size:24px; }
.nav-right {
    display:flex;
    align-items:center;
    gap:20px;
}
.nav-menu {
    display:flex;
    gap:10px;
}
.nav-menu a {
    color:white;
    text-decoration:none;
    padding:8px 16px;
    border-radius:6px;
    transition:background 0.3s;
}
.nav-menu a.active,
.nav-menu a:hover {
    background:rgba(255,255,255,.2);
}
.logout-btn {
    background:rgba(255,255,255,.2);
    border:1px solid white;
    color:white;
    padding:8px 16px;
    border-radius:6px;
    cursor:pointer;
    font-size:14px;
}
.logout-btn:hover {
    background:rgba(255,255,255,.3);
}
.container {
    max-width:1400px;
    margin:30px auto;
    padding:0 20px;
}
.stats-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
    gap:20px;
    margin-bottom:30px;
}
.stat-card {
    background:white;
    padding:25px;
    border-radius:12px;
    box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
.stat-label {
    font-size:14px;
    color:#666;
    margin-bottom:8px;
}
.stat-value {
    font-size:32px;
    font-weight:700;
    color:#1e3c72;
}
.stat-unit {
    font-size:16px;
    color:#666;
    margin-left:5px;
}
.tab-content { display:none; }
.tab-content.active { display:block; }
.card {
    background:white;
    padding:25px;
    border-radius:12px;
    box-shadow:0 2px 10px rgba(0,0,0,0.1);
    margin-bottom:20px;
}
.card-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
}
.card-title {
    font-size:20px;
    font-weight:600;
    color:#333;
}
.btn {
    padding:10px 16px;
    background:#1e3c72;
    color:white;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-size:14px;
    font-weight:600;
    transition:background 0.3s;
}
.btn:hover { background:#2a5298; }
.btn-success { background:#28a745; }
.btn-success:hover { background:#218838; }
.btn-danger { background:#dc3545; }
.btn-danger:hover { background:#c82333; }
.hot-wallet-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color:white;
}
.hot-wallet-card .stat-value { color:white; }
.hot-wallet-card .stat-label { color:rgba(255,255,255,0.9); }
.address { 
    font-family:monospace; 
    font-size:13px;
    word-break:break-all;
}
.alert {
    padding:12px;
    border-radius:6px;
    margin-bottom:15px;
}
.alert-success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
.alert-error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
.modal {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.5);
    justify-content:center;
    align-items:center;
    z-index:1000;
}
.modal.active { display:flex; }
.modal-content {
    background:white;
    padding:30px;
    border-radius:12px;
    width:90%;
    max-width:450px;
}
.modal-title {
    font-size:24px;
    font-weight:600;
    margin-bottom:20px;
    color:#333;
}
.form-group {
    margin-bottom:15px;
}
.form-group label {
    display:block;
    margin-bottom:6px;
    color:#555;
    font-weight:500;
}
.form-group input,
.form-group textarea {
    width:100%;
    padding:10px;
    border:2px solid #e0e0e0;
    border-radius:6px;
    font-size:14px;
}
.form-group input:focus,
.form-group textarea:focus {
    outline:none;
    border-color:#1e3c72;
}
.modal-actions {
    display:flex;
    gap:10px;
    justify-content:flex-end;
    margin-top:20px;
}
table {
    width:100%;
    border-collapse:collapse;
}
th {
    text-align:left;
    padding:12px;
    border-bottom:2px solid #e0e0e0;
    color:#666;
    font-weight:600;
    font-size:14px;
}
td {
    padding:12px;
    border-bottom:1px solid #f0f0f0;
    font-size:14px;
}
.status {
    display:inline-block;
    padding:4px 12px;
    border-radius:12px;
    font-size:12px;
    font-weight:600;
}
.status.pending { background:#fff3cd; color:#856404; }
.status.confirmed { background:#d4edda; color:#155724; }
.status.completed { background:#d4edda; color:#155724; }
.status.failed { background:#f8d7da; color:#721c24; }
.tx-link {
    color:#1e3c72;
    text-decoration:none;
}
.tx-link:hover {
    text-decoration:underline;
}
.loading {
    text-align:center;
    padding:40px;
    color:#999;
}
.empty-state {
    text-align:center;
    padding:40px;
    color:#999;
}
</style>
</head>

<body>

<div class="navbar">
    <div class="nav-content">
        <h2>üìä Admin Dashboard</h2>
        <div class="nav-right">
            <div class="nav-menu">
                <a href="#" class="nav-link active" data-tab="dashboard">Dashboard</a>
                <a href="#" class="nav-link" data-tab="users">Users</a>
                <a href="#" class="nav-link" data-tab="deposits">Deposits</a>
                <a href="#" class="nav-link" data-tab="withdrawals">Withdrawals</a>
            </div>
            <span id="adminUser"></span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>
</div>

<div class="container">
    <div id="alertContainer"></div>

    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Users</div>
                <div class="stat-value" id="totalUsers">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total User Balances</div>
                <div class="stat-value"><span id="totalUserBalances">-</span><span class="stat-unit">USDT</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Deposits</div>
                <div class="stat-value" id="totalDeposits">-</div>
                <div style="font-size:14px; color:#666; margin-top:5px;">
                    <span id="totalDepositAmount">-</span> USDT
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Pending Deposits</div>
                <div class="stat-value" id="pendingDeposits">-</div>
                <div style="font-size:14px; color:#666; margin-top:5px;">
                    <span id="pendingAmount">-</span> USDT
                </div>
            </div>
        </div>

        <div class="card hot-wallet-card">
            <div class="card-header">
                <div class="card-title">üî• Hot Wallet</div>
                <button class="btn btn-success" onclick="openWithdrawModal()">üí∏ Withdraw</button>
            </div>
            <div style="margin-bottom:20px;">
                <div class="stat-label">Address</div>
                <div class="address" id="hotWalletAddress">Loading...</div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <div>
                    <div class="stat-label">USDT Balance</div>
                    <div class="stat-value" id="hotWalletUSDT">-</div>
                </div>
                <div>
                    <div class="stat-label">BNB Balance</div>
                    <div class="stat-value" id="hotWalletBNB">-</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title">Recent Deposits</div>
                <button class="btn" onclick="loadDeposits()">üîÑ Refresh</button>
            </div>
            <div id="recentDepositsContainer">
                <div class="loading">Loading deposits...</div>
            </div>
        </div>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">All Users</div>
                <button class="btn" onclick="loadUsers()">üîÑ Refresh</button>
            </div>
            <div id="usersContainer">
                <div class="loading">Loading users...</div>
            </div>
        </div>
    </div>

    <!-- Deposits Tab -->
    <div id="deposits-tab" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">All Deposits</div>
                <button class="btn" onclick="loadAllDeposits()">üîÑ Refresh</button>
            </div>
            <div id="allDepositsContainer">
                <div class="loading">Loading deposits...</div>
            </div>
        </div>
    </div>

    <!-- Withdrawals Tab -->
    <div id="withdrawals-tab" class="tab-content">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Withdrawal History</div>
                <button class="btn btn-success" onclick="openWithdrawModal()">üí∏ New Withdrawal</button>
            </div>
            <div id="withdrawalsContainer">
                <div class="loading">Loading withdrawals...</div>
            </div>
        </div>
    </div>
</div>

<!-- Withdraw Modal -->
<div id="withdrawModal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title">Withdraw from Hot Wallet</h3>
        <form id="withdrawForm">
            <div class="form-group">
                <label for="toAddress">Destination Address</label>
                <input type="text" id="toAddress" placeholder="0x..." required>
            </div>
            <div class="form-group">
                <label for="amount">Amount (USDT)</label>
                <input type="number" id="amount" step="0.01" min="0.01" placeholder="10.00" required>
            </div>
            <div class="form-group">
                <label for="notes">Notes (Optional)</label>
                <textarea id="notes" rows="3" placeholder="Reason for withdrawal..."></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" onclick="closeWithdrawModal()">Cancel</button>
                <button type="submit" class="btn btn-success" id="withdrawBtn">Withdraw</button>
            </div>
        </form>
    </div>
</div>

<script>
/* ================================
   API BASE CONFIG (FIXED)
================================ */
  const API_BASE =
    location.hostname === "localhost"
      ? "http://localhost:3000"
      : "https://crypto-deposit-backend-production.up.railway.app";

const token = localStorage.getItem("adminToken");

if (!token) {
  window.location.href = "/admin-login.html";
}

document.getElementById("adminUser").textContent =
  localStorage.getItem("adminUser");

/* ================================
   API HELPER
================================ */
async function api(path, options = {}) {
  const res = await fetch(API_BASE + path, {
    ...options,
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token,
      ...(options.headers || {})
    }
  });

  if (res.status === 401) {
    logout();
    return;
  }

  return res.json();
}

/* ================================
   UI HELPERS
================================ */
function showAlert(message, type = "success") {
  const alertDiv = document.createElement("div");
  alertDiv.className = `alert alert-${type}`;
  alertDiv.textContent = message;

  const container = document.getElementById("alertContainer");
  container.appendChild(alertDiv);

  setTimeout(() => alertDiv.remove(), 5000);
}

/* ================================
   NAV TABS
================================ */
document.querySelectorAll(".nav-link").forEach(link => {
  link.addEventListener("click", e => {
    e.preventDefault();

    document
      .querySelectorAll(".nav-link")
      .forEach(l => l.classList.remove("active"));
    link.classList.add("active");

    const tabName = link.dataset.tab;
    document
      .querySelectorAll(".tab-content")
      .forEach(t => t.classList.remove("active"));
    document.getElementById(`${tabName}-tab`).classList.add("active");

    if (tabName === "users") loadUsers();
    if (tabName === "deposits") loadAllDeposits();
    if (tabName === "withdrawals") loadWithdrawals();
  });
});

/* ================================
   LOADERS
================================ */
async function loadStats() {
  try {
    const data = await api("/api/admin/stats");
    if (!data?.success) return;

    const { stats, hotWallet } = data;

    document.getElementById("totalUsers").textContent = stats.totalUsers;
    document.getElementById("totalUserBalances").textContent =
      stats.totalUserBalances.toFixed(2);
    document.getElementById("totalDeposits").textContent =
      stats.totalDeposits;
    document.getElementById("totalDepositAmount").textContent =
      stats.totalDepositAmount.toFixed(2);
    document.getElementById("pendingDeposits").textContent =
      stats.pendingDeposits;
    document.getElementById("pendingAmount").textContent =
      stats.pendingAmount.toFixed(2);

    document.getElementById("hotWalletAddress").textContent =
      hotWallet.address;
    document.getElementById("hotWalletUSDT").textContent =
      hotWallet.usdtBalance.toFixed(2);
    document.getElementById("hotWalletBNB").textContent =
      hotWallet.bnbBalance.toFixed(4);
  } catch (err) {
    console.error("Stats error:", err);
  }
}

async function loadDeposits() {
  try {
    const data = await api("/api/admin/deposits?limit=10");
    const c = document.getElementById("recentDepositsContainer");

    if (!data?.success || !data.deposits.length) {
      c.innerHTML = `<div class="empty-state">No deposits yet</div>`;
      return;
    }

    c.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>User</th><th>Amount</th><th>Status</th>
            <th>TX</th><th>Date</th>
          </tr>
        </thead>
        <tbody>
          ${data.deposits.map(d => `
            <tr>
              <td>${d.user_email}</td>
              <td>${Number(d.amount).toFixed(2)} USDT</td>
              <td><span class="status ${d.status}">${d.status}</span></td>
              <td>
                <a href="https://bscscan.com/tx/${d.tx_hash}" target="_blank">
                  ${d.tx_hash.slice(0, 10)}...
                </a>
              </td>
              <td>${new Date(d.created_at).toLocaleString()}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>`;
  } catch (err) {
    console.error(err);
  }
}

async function loadUsers() {
  const data = await api("/api/admin/users");
  const c = document.getElementById("usersContainer");

  if (!data?.success || !data.users.length) {
    c.innerHTML = `<div class="empty-state">No users yet</div>`;
    return;
  }

  c.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Email</th><th>Address</th><th>Balance</th>
          <th>Total Deposited</th><th>Deposits</th><th>Joined</th>
        </tr>
      </thead>
      <tbody>
        ${data.users.map(u => `
          <tr>
            <td>${u.email}</td>
            <td class="address">${u.address || "N/A"}</td>
            <td>${(+u.balance || 0).toFixed(2)} USDT</td>
            <td>${(+u.total_deposited || 0).toFixed(2)} USDT</td>
            <td>${u.total_deposits}</td>
            <td>${new Date(u.created_at).toLocaleDateString()}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>`;
}

async function loadAllDeposits() {
  const data = await api("/api/admin/deposits?limit=100");
  const c = document.getElementById("allDepositsContainer");

  if (!data?.success || !data.deposits.length) {
    c.innerHTML = `<div class="empty-state">No deposits yet</div>`;
    return;
  }

  c.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>User</th><th>Amount</th><th>Status</th>
          <th>Confirmations</th><th>Swept</th><th>TX</th><th>Date</th>
        </tr>
      </thead>
      <tbody>
        ${data.deposits.map(d => `
          <tr>
            <td>${d.user_email}</td>
            <td>${(+d.amount).toFixed(2)} USDT</td>
            <td><span class="status ${d.status}">${d.status}</span></td>
            <td>${d.confirmations}</td>
            <td>${d.swept ? "‚úÖ" : "‚ùå"}</td>
            <td>
              <a href="https://bscscan.com/tx/${d.tx_hash}" target="_blank">
                ${d.tx_hash.slice(0, 10)}...
              </a>
            </td>
            <td>${new Date(d.created_at).toLocaleString()}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>`;
}

async function loadWithdrawals() {
  const data = await api("/api/admin/withdrawals");
  const c = document.getElementById("withdrawalsContainer");

  if (!data?.success || !data.withdrawals.length) {
    c.innerHTML = `<div class="empty-state">No withdrawals yet</div>`;
    return;
  }

  c.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>To</th><th>Amount</th><th>Status</th>
          <th>TX</th><th>Admin</th><th>Notes</th><th>Date</th>
        </tr>
      </thead>
      <tbody>
        ${data.withdrawals.map(w => `
          <tr>
            <td class="address">${w.to_address}</td>
            <td>${(+w.amount).toFixed(2)} USDT</td>
            <td><span class="status ${w.status}">${w.status}</span></td>
            <td>${w.tx_hash ? `
              <a href="https://bscscan.com/tx/${w.tx_hash}" target="_blank">
                ${w.tx_hash.slice(0,10)}...
              </a>` : "N/A"}
            </td>
            <td>${w.admin_username || "N/A"}</td>
            <td>${w.notes || "-"}</td>
            <td>${new Date(w.created_at).toLocaleString()}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>`;
}

/* ================================
   WITHDRAW
================================ */
document.getElementById("withdrawForm").addEventListener("submit", async e => {
  e.preventDefault();

  const btn = document.getElementById("withdrawBtn");
  btn.disabled = true;
  btn.textContent = "Processing...";

  try {
    const data = await api("/api/admin/withdraw", {
      method: "POST",
      body: JSON.stringify({
        toAddress: toAddress.value,
        amount: amount.value,
        notes: notes.value
      })
    });

    if (!data.success) throw new Error(data.error);
    showAlert("Withdrawal successful");
    loadStats();
    loadWithdrawals();
    closeWithdrawModal();
  } catch (e) {
    showAlert(e.message, "error");
  } finally {
    btn.disabled = false;
    btn.textContent = "Withdraw";
  }
});

/* ================================
   AUTH
================================ */
function logout() {
  localStorage.clear();
  window.location.href = "/admin-login.html";
}

/* ================================
   INIT
================================ */
loadStats();
loadDeposits();
setInterval(() => {
  loadStats();
  loadDeposits();
}, 30000);
</script>
</body>
</html>
